---
layout: post
title: TCP/IP知识
tags: [Computer Networking]
bigimg: /img/path.jpg
comments: true
---

* toc
{:toc}

# TCP/IP协议簇中需要知道的十大问题

![十大问题](http://p9.pstatp.com/large/pgc-image/1529747996683fb281bff37)

## TCP/IP模型

TCP/IP协议模型（Transmission Control Protocol/Internet Protocol），包含了一系列构成互联网基础的网络协议，是Internet的核心协议。

基于TCP/IP的参考模型将协议分成四个层次，它们分别是链路层、网络层、传输层和应用层。下图表示TCP/IP模型与OSI模型各层的对照关系。

![TCP/IP协议族层次](http://p3.pstatp.com/large/pgc-image/1529747996753bb75c26230)

TCP/IP协议族按照层次由上到下，层层包装。最上面的是应用层，这里面有http，ftp,等等我们熟悉的协议。而第二层则是传输层，著名的TCP和UDP协议就在这个层次。第三层是网络层，IP协议就在这里，它负责对数据加上IP地址和其他的数据以确定传输的目标。第四层是数据链路层，这个层次为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。

![数据封装过程](http://p3.pstatp.com/large/pgc-image/15297479967557bb410f072)

上图清楚地表示了TCP/IP协议中每个层的作用，而TCP/IP协议通信的过程其实就对应着数据入栈与出栈的过程。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。

![HTTP数据发送接收过程](http://p1.pstatp.com/large/pgc-image/1529747996764c19d6169dd)

## 数据链路层

物理层负责0、1比特流与物理设备电压高低、光的闪灭之间的互换。 数据链路层负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点,这些节点是通过MAC来唯一标识的(MAC,物理地址，一个主机会有一个MAC地址)。

![数据链路层](http://p1.pstatp.com/large/pgc-image/152974799664162b1759ea1)

    封装成帧: 把网络层数据报加头和尾，封装成帧,帧头中包括源MAC地址和目的MAC地址。
    透明传输:零比特填充、转义字符。
    可靠传输: 在出错率很低的链路上很少用，但是无线链路WLAN会保证可靠传输。
    差错检测(CRC):接收者检测错误,如果发现差错，丢弃该帧。

## 网络层

#### IP协议

IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGMP的数据都以IP数据格式传输。要注意的是，IP不是可靠的协议，这是说，IP协议没有提供一种数据未传达以后的处理机制，这被认为是上层协议：TCP或UDP要做的事情。

#### IP地址

在数据链路层中我们一般通过MAC地址来识别不同的节点，而在IP层我们也要有一个类似的地址标识，这就是IP地址。

32位IP地址分为网络位和地址位，这样做可以减少路由器中路由表记录的数目，有了网络地址，就可以限定拥有相同网络地址的终端都在同一个范围内，那么路由表只需要维护一条这个网络地址的方向，就可以找到相应的这些终端了。

    A类IP地址: 0.0.0.0~127.255.255.255
    B类IP地址:128.0.0.0~191.255.255.255
    C类IP地址:192.0.0.0~239.255.255.255

#### IP协议头

![IP协议头](http://p1.pstatp.com/large/pgc-image/152974799666540968666ea)

八位的TTL字段。这个字段规定该数据包在穿过多少个路由之后才会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。

这个字段的最大值也就是255，也就是说一个协议包也就在路由器里面穿行255次就会被抛弃了，根据系统的不同，这个数字也不一样，一般是32或者是64。

#### ARP及RARP协议

ARP 是**根据IP地址获取MAC地址的一种协议**。ARP（地址解析）协议是一种解析协议，本来主机是完全不知道这个IP对应的是哪个主机的哪个接口，当主机要发送一个IP包的时候，会首先查一下自己的**ARP高速缓存（就是一个IP-MAC地址对应表缓存）**。

如果查询的IP－MAC值对不存在，那么**主机就向网络发送一个ARP协议广播包**，这个广播包里面就有待查询的IP地址，而直接收到这份广播的包的所有主机都会查询自己的IP地址，如果收到广播包的某一个主机发现自己符合条件，那么就准备好一个**包含自己的MAC地址的ARP包传送给发送ARP广播的主机**。

而广播主机拿到ARP包后会更新自己的ARP缓存（就是存放IP-MAC对应表的地方）。发送广播的主机就会用新的ARP缓存数据准备好数据链路层的的数据包发送工作。

RARP协议的工作与此相反，不做赘述。

#### ICMP协议

IP协议并不是一个可靠的协议，它不保证数据被送达，那么，自然的，保证数据送达的工作应该由其他的模块来完成。其中一个重要的模块就是ICMP(网络控制报文)协议。ICMP不是高层协议，而是IP层的协议。

当传送IP数据包发生错误。比如主机不可达，路由不可达等等，**ICMP协议将会把错误信息封包，然后传送回给主机**。给主机一个处理错误的机会，这 也就是为什么说建立在IP层以上的协议是可能做到安全的原因。

#### ping

ping可以说是ICMP的最著名的应用，是TCP/IP协议的一部分。利用“ping”命令可以检查网络是否连通，可以很好地帮助我们分析和判定网络故障。

例如：当我们某一个网站上不去的时候。通常会ping一下这个网站。ping会回显出一些有用的信息。一般的信息如下:

![ping信息](http://p3.pstatp.com/large/pgc-image/15297479966579ef4c84279)

ping这个单词源自声纳定位，而这个程序的作用也确实如此，它**利用ICMP协议包来侦测另一个主机是否可达。原理是用类型码为0的ICMP发请求，受到请求的主机则用类型码为8的ICMP回应**。

ping程序来计算间隔时间，并计算有多少个包被送达。用户就可以判断网络大致的情况。我们可以看到， ping给出来了传送的时间和TTL的数据。

#### Traceroute

Traceroute是用来**侦测主机到目的主机之间所经路由情况的重要工具**，也是最便利的工具。

Traceroute的原理是非常非常的有意思，它收到到目的主机的IP后，首先给目的主机发送一个TTL=1的UDP数据包，而经过的第一个路由器收到这个数据包以后，就自动把TTL减1，而TTL变为0以后，路由器就把这个包给抛弃了，并同时产生**一个主机不可达的ICMP数据报给主机**。主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机，然后**刺激第二个路由器给主机发ICMP数据报**。如此往复直到到达目的主机。这样，traceroute就拿到了所有的路由器IP。

![traceroute信息](http://p1.pstatp.com/large/pgc-image/152974799671344c78e5f65)

#### TCP/UDP

TCP/UDP都是是传输层协议，但是两者具有不同的特性，同时也具有不同的应用场景，下面以图表的形式对比分析。

![TCP/UDP对比](http://p3.pstatp.com/large/pgc-image/15297479967902065f51602)

面向报文的传输方式是应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则IP层需要分片，降低效率。若太短，会是IP太小。

面向字节流的话，虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。

关于拥塞控制，流量控制，是TCP的重点。

TCP和UDP协议的一些应用
![TCP和UDP协议的一些应用](http://p1.pstatp.com/large/pgc-image/1529747996891b52522a08c)

什么时候应该使用TCP？
-- 当对网络通讯质量有要求的时候，比如：整个数据要准确无误的传递给对方，这往往用于一些要求可靠的应用，比如HTTP、HTTPS、FTP等传输文件的协议，POP、SMTP等邮件传输的协议。

什么时候应该使用UDP？
-- 当对网络通讯质量要求不高的时候，要求网络通讯速度能尽量的快，这时就可以使用UDP。

## DNS

DNS（Domain Name System，域名系统），因特网上作为**域名和IP地址相互映射的一个分布式数据库**，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机名对应的IP地址的过程叫做域名解析（或主机名解析）。DNS协议运行在UDP协议之上，使用端口号53。